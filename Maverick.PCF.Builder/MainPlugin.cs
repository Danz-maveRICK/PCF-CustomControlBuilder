using System;
using System.ComponentModel.Composition;
using System.IO;
using System.Linq;
using System.Collections.Generic;
using System.Reflection;
using XrmToolBox.Extensibility;
using XrmToolBox.Extensibility.Interfaces;

namespace Maverick.PCF.Builder
{
    // Do not forget to update version number and author (company attribute) in AssemblyInfo.cs class
    // To generate Base64 string for Images below, you can use https://www.base64-image.de/
    [Export(typeof(IXrmToolBoxPlugin)),
        ExportMetadata("Name", "PCF Custom Control Builder"),
        ExportMetadata("Description", "Easily create, build and deployment solution for your custom control using PCF."),
        // Please specify the base64 content of a 32x32 pixels image
        ExportMetadata("SmallImageBase64", "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"),
        // Please specify the base64 content of a 80x80 pixels image
        ExportMetadata("BigImageBase64", "iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+nhxg7wAAH5xJREFUeJzdnXd8W9Xd/9+StSXb8p6yvOPYiR3HGcYZEFZCCRQIDRRCoQWejkAZSegD/NrSpvx+heTXUkpLaVltoTxJWG0oIWSSndgZzrTjbXnKQ5Zka4/nj+sotiU7dkah/bxetqRz7j33e7733HO+81zRkxkrEHnFIPLzJSAWmAbkApMGP1OAaEAFaAAX0A+YBz+NwFmgevDzGND9ryYcP/jD/EhEXvG/koEq4DrgWmABUAiILnCOFFADCUPKFg357geOAzuA7cA2wHaZ6B0dfuGfBJGfwN9FYK1hzZj1K3WrxMANwAPALQjMGBXyODmp81JQRivRpmrZ89xeAGKmx5AyK4Xjfzg+8hQRUDT49zgwAGwE3ga2rDWs8V2AvjHpHxMiP+KLP3tsrNSt0qzUrXocqAM+A+5mFObJomWB77m351L/9wZcA24iEiMA0C3UMfeHc+g60zWeS6sHr/UZULdSt+rxlbpVmkvqzBiQXO4GV+pWKYFHgKcQ5rhRkTg3kQhdBFqdlopfV+Bz+5AqJPi9fsRhIvw+P/GlcahjVTgsDtq/aEebH0nc1HjicmIxt5rpPtuD3+vDXGvG2e0aeYl04NfAsyt1q9YAv11rWGO/nP29rCNwpW7V3UAV8CIjmCcKE6a6hKviKftxGZm3ZZBQmEBUmpZDLx7C5xaetCMvH0UeJ8dt9+CwOkgsSsIPNJU3I4+Tk3fbZGo/qEUdo6b+8wbU8WqmLJlC1ORoUq5LQTtFG4q0WOAFoGqQxsuGyzICV+pW6YE/MHxyB0CqleKxesj5RjaWVitppToGugcw7GghfaEeU4MpcKxYISbtxjQiUyI48dZJFBFyqtZVU7qqFOOZTuKK41BHqyh5dDrOfidStRRxmIie+l66j3Yz5f4piESQMisZRaSSMxvOYGsZtp6kAe+t1K16APjuWsOapkvte1iZtgyRX3ThtXAUlEXOWQZ8AhQMLZeES4icFEnRtwrx+N2YavuQaaTkXp/Lsb9WEj05GolCgqXVir39/FMljZDSsLERv9tP94lufC4fhi8M9J7qxVJnoeVQC5Y2C72NJkwnTCTOTESukSGPlmE8aaTkWyW0VbYjVUoZ6B5g8jfycDldOM1O/B4/qlQVYrk422vzfqcsck4Lwgp+cRBfGgMVwGvAakA+tCJmegyFy6bS3z2ARCFBHi5HHimnZWcrMfnRKONU1H5QS+9p0zDm4QNbq21QROD85xD4HD6cPU5sbcLI6qrspv1AO6aqPuKK4whPDMfSZqH+03piJkejn63HMeAk99ZcXC4nIokYWbgUe6dDDtwB6IHNgGfCHBCDaIV+5cXIgfHAx8BVQwtTrk0mPj8eh8WBTC3DNeDCbfeQfU02Jz8+ScuWlgnTeLGImhpF0T2F7PrZbnwOHzl35ZA2U8eOZ3ficwZJNvuB2xCE9PFhUJC+GAZmAFuALJVORcHSfLweH027GlHGKEksTKK/q5+Gzxq4bvW1HH//ON0nenB0OsZN2+VCmDIMr91L3n15xGbFcOjlcjJvzsTr8uLqd9H0z2FTYB2CvNowrsYHGTjRR3gysBPQa6doSZyewJl1VRTdU4jH7aHnbC+dlZ1E6CLoPNCJobyF3hMmPAMTfzouB/weYVCoU1VY2qwU3lNIa0ULTZ82kzAjAbvZjiRcQsGyfLSTtNEOi+Nut9n9T8arGk5wDsxGUJNSJBoJ2YuzSZuhw3DAgFglxtJqZeqdUxDJRDTvbMZj9XxpjBsJc40Zc42ZmIJovB4vDrODzv2dZHwtncK7CqnfWU/rrlaKH5ymadnb+nUETab3gg1PYA6MA/YhMBH9zXradrdSuqIUq9FK5WvH8Xv8pN2kw1Tbh7XGehm6fWUglovRpGsovr8YuUZGy+EWpGoZdZvq6G/oP3dYLVAGjK76DD7C4xGkZQh3JPtcgVQlxW3xUL2pGlW0ClWqCmmEhOZNhq808wB8Th/ufjenPjxF55lOrB39iETnBf1BZCP0WR66lfMYDwN/D8weWmBts1L8w2L8PgiPDycqNwq35avxuI4H9lY73RXdhCeE07arjWO/q8RaG3TjZwO/u1BbF9JElgEPjizs3NuJudaM3+fnzKdnaPn8XyeeXE64Blx47d6xDnkQYdF8Z7QDxlpE9AgaRshh7Bnw4LV5MddaJkLzVwoqnRqfyIfP7cPrGJWR1wPvIRh0h0M89gh8DYi4ZCrHQJgkjITceOKy4onWRRMep0GmFExbzgEnFqOV3uYejHVddJ7tvOzXr1lfQ/rNeuzG4QaauPw4NPFqOk8YsfXYIoDXHvzoO4veuP3NoDZGW4XvRuA6APGF8bhtHky1F17ZxwORWIS+OI2MWRmkFqYSlxWPNikSZaRy2HEDvQP0tfVhrDXScryF2n21tJ1uvyw0hIJUKUWbocXr9NLf0U/aVTpqt9adq76HITwZSxNRAWcQLBfEFcQx/eHpOC1OTrx7gp7qnosmsODGAgpvLiRnbjbhceEX1UZfax9H/36UQ+vK6W64vK6QrBuy0MSrqf28loEuG7F5sajClTSXGwCaERQJQQkfg4FPAS8oY1UU319ExtXpnP64CnmUgqSpCXz0wMcTIkoZoWTug3OZdddMtMkhbXW47W666rvobuqhr60Pm8mGy+YCvx+ZWo4mVk2MPobk/GQiEyMD51XtqGLrb7bSdKR5gqwKjeQZyWRen4lMJcOw30DNphoyr8ug85iRgZ4BgB8h2DrPO5VGtKEBVgHE5cWSOisFU4uZE387gTZDS2TyxEbNtcsXcN2j1yFTyYLqGg41UP3FWc7uPovhmGHcbco1cooWF3HVslLyFuSRtyCPE5tOsvHnGzG1mi7cwBhQRCoQAR2VHaTP12M8ZaR+ewPpc9MJqw3D0m55CkGsC0jcI0fgo8DLQxuddEceMx4oZs//34dEIaFucx0XQnqJnqVrlxKXFTesvKuui/INFZSvK6e/p39YXXJBMgnZ8USlRqGJ1aAIVyIOE+F2erCZbPS19dFR1U5DeWPgnBh9DEvXfoPM2ZkAvPfYexz56OhEeBaEovsKSb86HdeAi/qtDVRvrEZ/TRoisZjG7Y0APwR+G+oRFiOoMBkjG5UoJcx+opTOox3Ubqodk4B535nLrc/dOqys/Uw72367ncpPKgNlqYWp5F+fT868HFIKkpEqpOPuZNORZo79/Rh73toDwMylM1i6dikAG1d/wq4/7Rp3WyMRXxBP9sIsVHFq9v1qH+HJ4URER2CsMmJuNwM0Aln48Y1k4EIET1ZISDUyojK1GI+PbjK7+ZmbueZ7Vwd+u+1uPnn+E/b9ZT8gzIdl95dRfNs0EnISRmtm3PC6vex4dSeb124mY2Y6P/jgBwC8s/xdKjdWXuDssZGxIB2JTIqv30fd3qCn7ib8fDaSge8hiC8XhUWrFnLdo9cFflfvrOad5e/isDpQRipZuGIhV91Xijjs8ntSu+q7ePGaNUy/vZhv/uabAKye+QssnVdMyF+Hn7uHGhNUwC0X6xcpWlw0jHnbXtnO6996A4fVwbXLF/DToz9hzgNlV4R5AHGZcTx37Kcc21hJ42HBSLrsd/dekWsNYjGDPu5zPboxPCdcXfBAPgCKBMWwo0senz5qS+oYNct+f57Yfzz3Dz578TMiEiL44T8e5aYf3USYJOzykh+Kjmg1D/75QU5vOQ1AxqwM0mekX7HLIVivAwxcpIhW0H22B21+JFf/n/nIYwXRQ6KRMNA1MGpL97x8T+D75rWb2f3mHnLn5/Ls/mfQTdNdqQ6ERO68HApvnorXLei1Nz0V5GW9nFgE5xl4bU9lDwVfzycyQ0v97noyFmYw72dzmfX4TAx7QltbUgtTyZ2XA8CZ7WfY+vI2piyawsPvPIRYcvGPa8OhBt544E3K11dM+NzUqamIxMJclFmaSUT8pavzikQFMSUxIw0u14LAwHggx+fwcfCVg6TOSCVvYR5hsjD2/XI/+36xn4Gm0CNw6B1+84G3SMpL5P4/fmvCBJ76/BTrV20IGAzefeRvVG2vYv3K9fi8Y8YGhcTQubbkzpIJnz8UYcowZnx/BlKllIJv5yNWBNrOAeLFQPG5koFmGxWvVnDozXISCxJJmpM4asOqKBW583MB+PDZjwB47NPHxkVUxYYKNr2wKfCovf3QnylfV86f/+svAFz/2HWEx4VTdn9ZYDSNhr62PpqPNVN/qD5k/dRFU8ZFUyiIFWKmPFDAsbeP0bGng+oNZ8n4WvrQQ6ZLEMLCACFKaso9BRx+6QgDbQM4ukZ3RRbfFuA7+/+6n1t+csu4FovOmk7WrVgPgNvh4daf3kLR4iJObz3NzKUzACi9t5TSe0tDnt9V34W5w8zxrSfQ5enoazPx+hNvIEdOck4yj298jMRJ52+8bpoORbgCh3XiblWfw4dcI2fm92ag0qrwur30tZmpI3CzCiVA1rlffq+fPoNgN4wriqPh49FdpHlXTwLgxKcnUMeomf/QvHERpY5WEx6rwdrdT2phKgDLfn8vDqsDRfjw1d/tcFN/oB5VlIqmg80U3zmNdSvWs/vjPfTTz7TcQp6vfh5bn50NP9tAdU01HzzzIcsHBepzSJ+RTtWOqnHRNxItFa207Wgj8/ZMWve2knxVMooEBY4OB0CWBCEEDIlGgtvsJkwWxswVMwhPCB+VgdpkLSmDnW883ETxrcUhjwsFTYyGp/c9jaXTQow+JlA+knmv3Ps78mZNwu/zs/7pDRicBj64832++95/cTruNPFhcfQ2m/C6vSxccSObXvgMq8OKWBy8eGWVZl40A9t2tAFgN9nJuSUbmUZOR3nHueoMMZAskoiYfM9kIidH0rK7hbqt9dTvHn30JeYlEh4rxCxGJkWSdVXmhIiSKqTE6GPoqO6gfH0Fhz88wue/2hKof3XJq2z820YKFxdywxM3sLry54QTwbbfbkeqkKKfrsdpc2J1WKndV4siXIE3zMOcG+fw/Q3fC7peZunE6BsKiUZC/gOTkWtkSFUy5BoZ9raABTtJDET5PX5O/PEE8YXxlK0oo+DOAmKyokdtNColKvA9Z042yQXJEyKqq7qL50p/RuvJVuoP1vPzJavZ8MwGAAzHDGz/cCeZsiy8gzGDiZMSefSVR6jdKxgy0qalYXPbECHGcMzA57/aQvdAN9Gx0XzxerAhIWVqChL5xUXypS5IRaaWo4xS4hpwsv/5A0OroyRAwI6u1Wk58ucjuAfcRKSNLj9FJJyvS5qcFPIYr9uLsdaIWCYmIeu84aC/u59VhU8RGa2lZEkJJUtKmLJoCj++8ceY2800H2tGQhgWl4Wa3TUk5QkLwvzl85hxryCSZM7OwA8ow+Sc2HSSh999COPZTj547SPsf7PRdrKNb750Xq0Pk4ShL9FTt+/CpriRMNWYcFqdtO9sJ+euHMRScSAYFFCJgYCVtL2ynUh9JNYaK63bWkdtVDlivgKwmWw0HWvm4HsHee+x/+H01tO8uvQPrMp+iv+e9DQN5cKUsOWlLbS72olPiwvIeAU35HPHd2+nakcVboeHMMIIQxw4J0CtVjXIwEy06kjkKjlNh5vQxGhY9KNFhKMhU5HFgXcPBESkc5i1dOZEeQeAucqMJkHD4j/dTObcjKHMA9CIEfIwAFDHq8mYk86CF64h9+6cURsVS4PFlTM7qvhx8Y956Z6XeePlN5EpZazctoIwJNSfref1ZW/g9/tpO9VGMsk0H2um9eT5m7TsD8soWVKC3WzDhw+NUkNjRWPI68dlxZEwKQGvy4up20TT4SZiM2JJ0aVgcDQTmx4bZLiYfsd09NPTxsW0kahZV8OO1Ts4u7UmmBdAwCVf+2EtR94+whc/2TWm3c/nDvahltwxnYXLFyJGRCKJnNpymoj4CNKn6YmRxdBxtoO2U20oIpTIwmT0u/qpPzh8hEnkErLnZBNGGIoIBZ3VnXTWnHdn1h9s4IP//gCAghsKsDitmDFz/NMTVO+spspQRd7kSTz05wdDCuCPfPwIZfeXXZhjQ5B6QypXPz+fkodLCJMFDZx+MUPs+5m3ZDDtvmkoExRoUkf3fzj6Qwul+TdMRowYtVRF9c5qAIoWF2J2WXDhQhWlRh2jxuV1EUYY9QeDtYecuTlMLp2MsdOI1Wal/UxAZGDPG7vpaRa8gk1HG7FgRhetQywR09/dz5N/e4I1p9eQlB96Xga4ffVtPP7pY1z93aspuCGf5PykwNQQCgMdAxjKDdRsqSGxIMgIbJMwZAT21pnw+yF1bipanZa2HW0jn3kArN39QWUA+ul6tJGC5639dDt+vx9EIqqp4vv3fZ+oFC3RumgGGCBOFUdL5XAjxdbfbEUVreaRj5fzeMoTNHmb2PTLTeTOz+HAOwc48dlJnj+zGr/fz5SbprL42cVklWaFGhljImVKCilTUgK/vR4vxtouKv9xjLO7azBUnndyqRPV6GbqaDncQsWrh0c2ZQor05bdIfKLshCBvd2OLEaG/qo0ZEoZTbubA0GKQxGZGMm0W4qCypWRSo7+/Si9BhMejxttkhZjrZGbv/k17nrxLkBwBO39/T7cTjcOi4Orvzs/4LV768G3yZqdSc68HErvKkVmllF9uBqlQolUKWPxs4vRpmgRiURklWYRo4+5LEZasVhMeKyG7DnZiCVhnPr8VKAudV4KvQ0m4ibFEZMXQ/vBIY59McclCE4SQNCF00p1GKu7MOwy4HOEtoT0Gnpx291IlcGOoLQiHVUHqvHhpaOqg/teXTasXpus5eF3HubFO1+kqb+J91e+z9dXf513lr+LrkjH3O/MBSBhUgIP/eUhzB1meg0mnFYHne0dtLW34unx4seHSCrCZxdoFElE+F1+pClSPF1CcKfX50MSHYbT6EIkEaHUKfC7/Xj6PTg6nUTPjqL3cC+abA0t21rp7eyl5eBwF2vdP+tILkvm4C8PhmJFvQQhNhgAV6+Lo68dxW3xkHFbBr2qXsxngmNquuq66KrvCilA60v0+PCiECnoqOoIqgcoWTKd5/f8gs9f/pxT+0+Tu2MSxbcVM/fbczBUGqjeWU2HoRNjvRGP2IMyWoFEKSV1egqmZhPxk+Jx290kZw2//qlPTxEvi0cdrUaVdX5eU6YpsZls2OyCBqHNjkSWKsNstKDMVeLFi0VkJv1reuq2n5cVRRIREZmR2HsdzHiihKa9zXQdGhZzWScBhrmvCh8sQh2jQhmhpCutiyNngv2sboeb9qr2kAwsvLmQWG0MdquDw/88TMWGw8z4RrBNLntONtlzhJjNXkMvFRsq+PXNL+GP9mOuN5N7ay4RknBcNjfKSAX2PgcHf3uI8LRwzn5cgzxKzkHTIcL14bgsgiTmNDlp13dgbRKm9XC9sBCeq5dFCFOFtckaqDv33dpkpb1i+A1PKE1gyh0FSGQSdv1yN/aOoCyxExJgGIdaDragSVTTfqhjZJbPMDSUN1KyJJgxHdUddPQZiYuMJT41nroDdSEZCIIhYvcbu2nraEMWLiP1plSMVUbEEjFVH1QRnRdNd2U3ingFlmrBw+Y0OoXPruGf5zD098i6Cx0X1JbFyfH1x4nNiyV1bgpn/ydIDjwsQciNqGUwhLfrcBeiWSJsLTZy7sqhZU8L9tbg/LzqL6pDEubz+njk3eVMvWbKqLEwDYcaKN9UjrHdiCZBQ2xULKbaXk68c2Kook5bh2AJcZmCkgj/JTBXm1GlqFCVqXDbgyJwawDjOQ17O4MMFEvFTLt7Go6b7GjiNPjcXuo+DJbX+lr7MNYZic+KH1aef33+qAS1nmxl62+2cnLzKeJmxSFRSehrNo+pNn5ZECvELPjFNRx7r5L67Q3YOoKexu1wPkJVgkhwqvtcPrwyL027mzj+xnHyl+Zj+GL04J/J1+ZdkJheQy8bV2/kw2c+wlgnTMKObgcuqwvTyUsLCLpS8Hv8tB9vZ/YPZhOhi6Dx08aRhzyPmKpzI3ALQqa3GqDh4waSFySTvSILp8WBVCvF3ecednZCTgLTbxvbkGoz2dj2yvaQsSo+py8wn31V4ehwcHxdJRGpQZapAQSeBcLbBhDioe86d0TbjraANTbrjsxhj3HZt67i9l/cPuqFB3oG2PX6Lva8tVeI8/s3hsPkJDwlqPgTBJ4Niw98G7hLqpUy89EZqGPUiEQi/H7wON0YdrQEJnOpMjjeD6D5aDPl6yuoeL8Cj/PfJ+1hKMQKMcXfL+bwrwW1zXLWEioF4u1zX0aGt9UB6RKNhMxbMpGppTitLqytVvpb+xloHsDvFVQ7fYme6bdPB7+fzppOGisar2j88r8KqlQVsVNjaf6smew7s2na3DgyB6YJyDwX3jY0zcEP+ICbfC4fPSd7MB7pQpmgYNZ3ZuLxuOmqPB+TbG43U7W9iqodVRgqW7B2hTYw/LvBbXGTOi+F7uPdyLRSEksS6Tk5LLj+OUCw64uDM5XeAnpA2H6k9OnZTF1SSNXn1bgdHhJK4/lPRnRRNDNXzqS3wUTWHVl07OnEZRu2ePYAbwwtGMnAfgaDqMUSERGJEdRsO0vr/lZq36/F6/Yx/Yfjd2H+OyE8S8NA2wDycDnTlhaRsyCbmStn4OgdZvt8kSH2UwidaPMKsNze7kg7+dEp3HY3XoeX5GuSadvRNrLB/wiEqcLIvXUS6hg17cfbKN9hIHlOMsmFSXTsCejHzQi8GX5uiFQvN9AJLLE2WlGnqEmemUT3yS5cJteXplZdSURPjabxs0ZhP4coFSK5iMaNjSMViB8AR4adOEbC9UmE/RCyba02uo93/0cyDiCqMIoZ3y5BrBZx+q9nyF+Sj8/vo+PQMMvM5wg5IsMRYhEZiu8BgSBjqVZK6dOzSZybQPI1ycz5SRlxs+LGOP2rj8i8SMoeuYotT25FppHjc/oof718pJXbgsCLkBgrW7MPaAVuByFSqWVPK7MfnY08Usap9afwunx47B787i9l67xLRnxJPIhBFi3F4/BgqurDYXRgajLh6Q/Ifg8DX4RsYBx7JhwHdEAgSLrtWBtOmwtFjBKn2Un+3fkokhT0VfVd1s5dScTOiCXzpgxq36+l61QXpctL6Tgl5EADQ5n3JsK+OKFxgXTXc1gOTGEwa93Z5USUJ0I3W4e70E3i5ATMLcFm/68ywlPCUUWrmLlihmDp/tMheg4HJVEeROj7mBjPrh1e4O8Ij3I0QH9zP3arHcTQfNCATCUlMieSqElabF22C2WBf2nIvTsHt8uDKl7F6b+cJv/OfJr2NmHcHxREUIuQaD12oskFFpGh6AJuQpgTAeit7MWw3UD6XD31/2igfX87+YvzUSWrkGgu+656l4zUG1NRRCqZ/u1iIalQJOLkx6do/yJIf29F6Ou4NiuciFO1FiE3IiAcuc1uDvy/g0RPjeL656+jYW8Dylgli15aOIFmryyiC6OIL43HbXVhaTXjsrkxHu8k5doU2ncGMc+A0MexEwKHYKJe6TPAHOD00EKXxcXBPx7CsK+FSTfmUrdLcA2KpeIvbTQqEoUIMp/Pj35OGp37jSQVJdFd203P0V4Mm4Os7KcR+nZmIte5mN3bLMD/APMQVmhcJheOLgeTlkzC3ufA0mIm9+s5JM5KIkwlJvNrWXQcDO0jvtxQpiiJyAhn/o/m07CzAVuLjWn3F2HpseDz+WjeaRi6yp7DPoSRN7GNGS5h+zs78C6gBWYB+H1+Ois6MTWYEMvE5Fybze6f7EaZqEI/K42GLQ1oMjVE5Ucx0DJ65tMFaZaKSShLQBIhwWEc1MsHac/9Zi6F35iK0+7C4/Lg9XqJzIlEGa2k9VAbbV+0h2LeK8C9jDASjI+YS9s/0AtsQpAVFyLsJ4jX7sXebkcaI6zMSUVJHH3zCG6zG5fJRc6t2WQuzMLcacbZM3GfyNSHp9BxtJO0uWmkzkul41AH81fPp7u2C3N9H51VRrT6SBx9djLnZ6LQKjjwfw+EulYfAuN+NdiXieMS9g8cCT3CNilBq0fpM6XINXLajrWijlOjTdVy6iNhCh0aJiGWiNGma5HIw3DZPfTVm5Bo5GjLsggz9dNZHrwvQs7SbKIzoolMjmTLk1vxe/0kzU/E1e/G1mFDLBEx0BwyOGAz8L21hjWNF70N8gT2zhoPmhCS7+5BMPsEoIlVc+DXB7C0WEnMT2TvC/swnTaRXDI8hk+dGI4iXo1HJMavEPb6iS1JRjsrD3VW6ORsc7OF7ppuVFEqZFFSih8tRhGtpOdID6IwEWkL9CNPaQbuWWtYs2itYU3j5ej4Je+hOgInEUaiBSGFTNVyqBX99XoSCxPpqe9BJBORdrWO+s0NuM3nrb2ytHgaTlvxtfXg7OpHnRqJPSKKrkON+ExmnMbgTc2uerKUgR4bMrUMw14DLTtbAyql2+Km+3jABdEN/By4b61hzbBQlrLIORff23GqchOFHcFy+yrwoMvkeqxmXU06IlDr1fhcvlDCK45+NxH2PrKfv50754pZ91IVTZ/V4Le78Osig44H2PrkNgBifhqD2xzCC+inEfgN8MZaw5orsq3clRTSrMBLCLuA3ICfBwYaB0bdCl4ercTcH0f7+gp+908F1n3nA3kikpRYDMH6tnaKFv08PYZDhqGRtBPaCv5SIcEP+EWE3DL38sCHMGlv5vzLCK5DeBnBVAYnD1dNB5npEVg7+nB5/ERMTsLr9SOShdHX4QxJnrPXSfUH1X5Hp+MEwssItgHb1rasGf/LCC62237hT7QiYwV8ea/DiEN4HUYOwa/DUHN+tA4M/vUi6KrnXodRg/A6jHHprZcVfiDMz/8CcnS3SqJ82q0AAAAASUVORK5CYII="),
        ExportMetadata("BackgroundColor", "#D9D9D9"),
        ExportMetadata("PrimaryFontColor", "Blue"),
        ExportMetadata("SecondaryFontColor", "Blue")]
    public class MainPlugin : PluginBase
    {
        public override IXrmToolBoxPluginControl GetControl()
        {
            return new MainPluginControl();
        }

        /// <summary>
        /// Constructor 
        /// </summary>
        public MainPlugin()
        {
            // If you have external assemblies that you need to load, uncomment the following to 
            // hook into the event that will fire when an Assembly fails to resolve
            // AppDomain.CurrentDomain.AssemblyResolve += new ResolveEventHandler(AssemblyResolveEventHandler);
        }

        /// <summary>
        /// Event fired by CLR when an assembly reference fails to load
        /// Assumes that related assemblies will be loaded from a subfolder named the same as the Plugin
        /// For example, a folder named Sample.XrmToolBox.MyPlugin 
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="args"></param>
        /// <returns></returns>
        private Assembly AssemblyResolveEventHandler(object sender, ResolveEventArgs args)
        {
            Assembly loadAssembly = null;
            Assembly currAssembly = Assembly.GetExecutingAssembly();

            // base name of the assembly that failed to resolve
            var argName = args.Name.Substring(0, args.Name.IndexOf(","));

            // check to see if the failing assembly is one that we reference.
            List<AssemblyName> refAssemblies = currAssembly.GetReferencedAssemblies().ToList();
            var refAssembly = refAssemblies.Where(a => a.Name == argName).FirstOrDefault();

            // if the current unresolved assembly is referenced by our plugin, attempt to load
            if (refAssembly != null)
            {
                // load from the path to this plugin assembly, not host executable
                string dir = Path.GetDirectoryName(currAssembly.Location).ToLower();
                string folder = Path.GetFileNameWithoutExtension(currAssembly.Location);
                dir = Path.Combine(dir, folder);

                var assmbPath = Path.Combine(dir, $"{argName}.dll");

                if (File.Exists(assmbPath))
                {
                    loadAssembly = Assembly.LoadFrom(assmbPath);
                }
                else
                {
                    throw new FileNotFoundException($"Unable to locate dependency: {assmbPath}");
                }
            }

            return loadAssembly;
        }
    }
}